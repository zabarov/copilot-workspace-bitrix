# Правила разработки под 1С-Битрикс

Свод правил для любых проектов на Bitrix Framework (веб/портал/модули), основанный на учебных курсах 1С-Битрикс и внутренних требованиях.

## Базовые принципы
- Используйте ядро D7, современные API и типы (PHP 8.1+), избегайте устаревших процедурных вызовов.
- Всегда подключайте пролог/эпилог, проверяйте `B_PROLOG_INCLUDED === true`.
- Подключение модулей — через `Loader::includeModule()`, работайте только с установленными модулями.
- Работа с данными — через ORM/HL-блоки/REST, избегайте прямых запросов без фильтрации.
- Любой код сопровождайте тестами/статиками: PHPUnit, PHPStan, Deptrac, PHP-CS-Fixer.
- Ссылайтесь на официальную документацию (API, user help) и обновляйте код под текущие версии, не используйте устаревшие методы.

## Структура модулей и компонентов
- Модуль в `local/modules/<module_id>/` должен содержать `install/`, `lib/`, `admin/`, `lang/`, `tools/` (при необходимости `components/`, `js/`, `templates/`).
- `install/version.php` обязан содержать актуальную версию и дату; версии пакетов обновлений должны совпадать с версией модуля.
- Компоненты 2.0: шаблоны в `templates/.default/`, параметры через `arParams`, результат в `arResult`, фильтрация/валидация входящих данных обязательна.
- Не дублируйте шаблоны/блоки — выносите общие части, используйте параметры и категории/типы блоков вместо копирования.
- Шаблоны/языковые файлы должны лежать в зеркальных путях (`lang/<LANG>/...`), не прошивайте строки в коде.
- События и модули: регистрируйте обработчики через `EventManager`, не модифицируйте ядро.

## Безопасность
- Формы: `bitrix_sessid_post()` и `check_bitrix_sessid()`, `B_PROLOG_INCLUDED`, защита от CSRF/XSS/SQLi.
- Экранируйте вывод (`htmlspecialcharsbx`), фильтруйте пользовательский ввод (типизация, белые списки, `ForSql()`).
- Права: проверяйте `CMain::GetGroupRight()`/`AccessController` для любого действия/раздела, не полагайтесь на фронтенд-валидацию.
- Файлы/загрузка: проверяйте MIME/расширения, ограничения по размеру, храните вне веб-доступа при возможности, используйте `CFile` API.
- Не раскрывайте диагностические сообщения пользователям, логируйте ошибки и скрывайте стектрейсы в продакшене.

## Локализация и контент
- Все текстовые строки в коде — в `lang/ru/**` с зеркальной структурой директорий.
- Не прошивайте пути/URL/ID в коде; используйте настройки, опции модулей, инфоблоки/HL-блоки или константы-конфиги.
- Соблюдайте правила форматирования документации/контента (табовые блоки, подсказки, предупреждения) при генерации обучающих материалов.

## Права и роли
- Настройка доступа на уровне модулей, инфоблоков, разделов и файлов — используйте штатные механизмы (группы, AccessController).
- Не выполняйте операции с контентом/данными без проверки прав; для API/REST — проверяйте токены/пользователя.

## Кэширование и производительность (основы)
- Используйте управляемый кэш Bitrix, композит для публичных страниц; для динамических вставок — области без кэша/фреймы.
- Компоненты: `StartResultCache/AbortResultCache/EndResultCache`, инвалидируйте кэш на событиях изменения данных.
- Минимизируйте количество запросов: используйте выборку нужных полей, фильтры, постраничку, индексы в БД/HL-блоках.
- Следите за N+1, используйте постраничку/seek и лимиты, не грузите лишнее.

## Данные, миграции, интеграции
- Миграции и DDL — идемпотентные; проверяйте наличие таблиц/полей перед созданием/изменением.
- При интеграциях с 1С/REST — логируйте обмен, обрабатывайте ошибки/ретраи, не храните чувствительные данные без шифрования.
- Для больших справочников и перегруженных сущностей — используйте HL-блоки/отдельные таблицы.

## Обновления и поставка
- Пакеты обновлений должны содержать полное дерево модуля в `install/local/modules/<module_id>/...` и актуальные `install/version.php`.
- `updater.php` копирует файлы в точный путь (`local/modules/...`), проверяет наличие модуля и защищён от прямого вызова.
- README и `description.ru` в пакетах обновлений фиксируют диапазон изменений, требования и инструкцию по установке.

## Тесты и проверки
- Минимальный набор: PHPUnit (bootstrap `local/phpunit/bootstrap.php`), PHPStan, PHP-CS-Fixer (dry-run), Deptrac.
- Все проверки запускаются из корня, артефакты — в `results/checks/**`.
- Перед запуском убедитесь, что конфиги и `composer.json` инициализированы под ваш `module_id` (через 40-tools-init).
- При разработке компонентов/модулей для маркетплейса — добавляйте тестовые сценарии/демо-данные, проверяйте установку/удаление.
